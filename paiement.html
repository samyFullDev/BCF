<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>BCF - Souscription de Parcelles</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="BCF-theme.css">
  <style>
    :root{--gold:#a67c00;--gold-hover:#c08d00;--bg:#f5f7fa;--txt:#1c2b27;--radius:10px;--border:#e4e1d5}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{background:#fff;border-bottom:1px solid #e3e3e3}
    .topbar{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:.6rem 1rem;position:relative}
    .logo-box img{max-height:80px;display:block}
    .timer-badge{position:fixed;top:.5rem;right:.5rem;background:#153c2e;color:#fff;font-weight:500;padding:.4rem .6rem;border-radius:10px;display:flex;align-items:center;gap:.35rem;font-size:.82rem;line-height:1;box-shadow:0 6px 14px -6px rgba(0,0,0,.3);z-index:1700}
    .timer-badge #pcLabel{display:inline}
    .timer-badge #pcTime{font-size:1rem;font-weight:700;font-variant-numeric:tabular-nums}
    @media(max-width:640px){.timer-badge #pcLabel{display:none}}
    main{max-width:1180px;margin:0 auto;padding:1.2rem clamp(.8rem,3vw,2rem) 2.2rem}
    h1.main-title{text-align:center;font-size:1.5rem;margin:1rem 0 1.2rem;color:#153c2e;font-weight:700}
    .info-box{background:#e6f1ff;border-left:4px solid #1d6fd8;padding:1rem 1.2rem;border-radius:8px;display:flex;gap:.85rem;font-size:.9rem;color:#134a91;margin-bottom:1.4rem}
    .warn-box{background:#fff7e1;border-left:4px solid #e3ae15;padding:.9rem 1.05rem;border-radius:8px;font-size:.8rem;color:#7a5800;display:flex;gap:.7rem;margin-top:1.2rem}
    .panel{background:#fff;border:1px solid var(--gold);border-radius:var(--radius);padding:1.3rem 1.4rem 1.6rem;box-shadow:0 2px 4px rgba(0,0,0,.04);margin-bottom:1.3rem}
    .panel h3{margin:0 0 .9rem;font-size:1.05rem;font-weight:600;display:flex;align-items:center;gap:.55rem;color:#153c2e}
    table.data{width:100%;border-collapse:collapse;font-size:.83rem}
    table.data tr td:first-child{width:38%;font-weight:500;color:#4b5954;padding:.55rem .65rem}
    table.data tr td:last-child{padding:.55rem .65rem;font-weight:600;color:#111}
    table.data tr:nth-child(odd){background:#fafafa}
    table.data tr{border-bottom:1px dashed #e0dfdc}
    table.data tr:last-child{border-bottom:none}
    .price-highlight{color:var(--gold)}
    .pay-area{text-align:center;margin-top:1.3rem}
    .btn-gold{background:var(--gold);color:#fff;border:none;padding:.95rem 2.4rem;font-size:.95rem;font-weight:600;border-radius:50px;cursor:pointer;display:inline-flex;align-items:center;gap:.65rem;box-shadow:0 3px 6px rgba(0,0,0,.15);transition:.25s}
    .btn-gold:hover{background:var(--gold-hover)}
    .card{background:#fff;border-radius:14px;padding:22px 24px 24px;margin-bottom:28px;box-shadow:0 4px 12px -2px rgba(0,0,0,.06);border:1px solid #eceae4}
    .recap-group-title{font-size:.72rem;letter-spacing:.9px;text-transform:uppercase;color:#54625d;font-weight:700;margin:1.1rem 0 .45rem}
    .recap-rows{border:1px solid #e9ece9;border-radius:10px;overflow:hidden}
    .recap-row{display:flex;justify-content:space-between;gap:1rem;padding:11px 15px;font-size:.84rem;border-bottom:1px solid #eee;background:#fff}
    .recap-row:nth-child(odd){background:#fafafa}
    .recap-row:last-child{border-bottom:none}
    .recap-label{color:#4c5b55;font-weight:500;max-width:50%}
    .recap-value{color:#15211e;font-weight:600;text-align:right;max-width:50%;word-break:break-word}
    .price-highlight{color:#a67c00;font-weight:700}
    .btn-gold{background:#a67c00;color:#fff;border:none;padding:.95rem 2.2rem;border-radius:40px;font-weight:600;font-size:.95rem;display:inline-flex;align-items:center;gap:.6rem;cursor:pointer}
    .btn-gold:hover{background:#c08d00}
    /* Modal & countdown styles */
    .mmodal{position:fixed;inset:0;display:none;z-index:1600;font-family:inherit}
    .mmodal.open{display:block}
    .payment-countdown{position:fixed;top:.75rem;right:.75rem;background:#28a745;color:#fff;display:flex;align-items:center;gap:.55rem;padding:.55rem .8rem;border-radius:14px;font-size:.78rem;font-weight:600;z-index:1600;box-shadow:0 4px 14px -6px rgba(0,0,0,.25)}
    .payment-countdown .pc-time{font-variant-numeric:tabular-nums;font-size:1rem;font-weight:700}
    .payment-expire-msg{margin:1rem 0 0;font-size:.82rem;font-weight:600;letter-spacing:.3px;text-align:center;display:none;padding:.85rem 1rem;border-radius:12px}
    .payment-expire-msg.show{display:block;background:#ffe8e8;border:1px solid #f2b1b1;color:#7d1212}
    .payment-modal{position:fixed;inset:0;background:rgba(15,25,30,.55);backdrop-filter:blur(4px);display:none;align-items:flex-start;justify-content:center;overflow-y:auto;padding:4rem 1rem 3rem;z-index:1500}
    .payment-modal.open{display:flex}
    .pm-dialog{width:100%;max-width:520px;background:#fff;border-radius:22px;padding:1.4rem 1.35rem 1.7rem;box-shadow:0 14px 40px -8px rgba(0,0,0,.25);position:relative;display:flex;flex-direction:column;gap:1rem}
    .pm-title{margin:0 0 .2rem;font-size:1.25rem;font-weight:700;color:#0d3d2d}
    .pm-close{position:absolute;top:.6rem;right:.6rem;background:#f0f4f2;border:none;width:40px;height:40px;border-radius:14px;cursor:pointer;font-size:1.2rem;font-weight:600;color:#19352b;display:flex;align-items:center;justify-content:center;transition:.25s}
    .pm-close:hover{background:#e3ece8}
    .beneficiary-box{background:#f6fbf8;border:1px solid #cfe6d9;padding:.85rem .9rem;border-radius:14px;font-size:.78rem;line-height:1.15rem;display:grid;gap:.4rem}
    .whatsapp-pay-wrapper{width:100%;display:flex;justify-content:center;align-items:center;margin:20px 0 14px}
    .whatsapp-pay-btn{background:#28a745;color:#fff;text-decoration:none;padding:.9rem 1.4rem;border-radius:8px;font-size:.9rem;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:.55rem;box-shadow:0 6px 16px -6px rgba(0,0,0,.30);transition:background .25s}
    .whatsapp-pay-btn:hover{background:#218838}
    @media(max-width:640px){.recap-row{flex-direction:column}.recap-value{text-align:left}.btn-gold{width:100%;justify-content:center}.pm-dialog{padding:1.3rem}.payment-countdown{right:.5rem;top:.5rem}}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="topbar">
      <div class="logo-box">
        <a href="index.html"><img src="logo-bcf.png" alt="BCF"></a>
      </div>
      <div class="timer-badge" aria-hidden="false">
        <i class="fa-regular fa-clock"></i>
        <span id="pcLabel">Temps restant</span>
        <strong id="pcTime" style="margin-left:.6rem">25:00</strong>
      </div>
    </div>
  </header>

  <!-- MESSAGE EXPIRATION (apparaîtra sous le bouton) -->
  <div id="paymentExpireMsg" class="payment-expire-msg" aria-live="polite"></div>

  <!-- MODALE D'INFO 20 MINUTES -->
  <div id="paymentInfoModal" class="mmodal" role="dialog" aria-modal="true" aria-labelledby="pimTitle" aria-hidden="true">
    <div class="pm-dialog" style="max-width:560px;">
      <button id="pimClose" class="pm-close" aria-label="Fermer">&times;</button>
      <h2 id="pimTitle" class="pm-title">Information paiement</h2>
      <p style="margin:0;font-size:.95rem;color:#263f36">Vous disposez de <strong>25 minutes</strong> pour effectuer le dépôt après avoir cliqué sur « Procéder au paiement ». Passé ce délai le bouton sera désactivé et vous devrez recommencer la procédure.</p>
      <div style="display:flex;gap:.6rem;margin-top:1rem">
        <button id="pimProceed" class="btn-gold" style="flex:1"><i class="fa-solid fa-check"></i> Procéder au paiement</button>
        <button id="pimCancel" class="btn-gold" style="background:#d42c2c;flex:1"><i class="fa-solid fa-xmark"></i> Annuler</button>
      </div>
    </div>
  </div>

  <main>
    <h1 class="main-title">BCF - Souscription de Parcelles</h1>

    <div class="card" id="recap-wrapper">
      <h3><i class="fa-solid fa-clipboard-list"></i> Récapitulatif de souscription</h3>

      <div class="recap-group-title">Informations personnelles</div>
      <div class="recap-rows" id="rows-personnel"></div>

      <div class="recap-group-title">Pièce d’identité</div>
      <div class="recap-rows" id="rows-piece"></div>

      <div class="recap-group-title">Contacts</div>
      <div class="recap-rows" id="rows-contacts"></div>

      <div class="recap-group-title">Adresse & Profession</div>
      <div class="recap-rows" id="rows-adresse"></div>

      <div class="recap-group-title">Parcelle sélectionnée</div>
      <div class="recap-rows" id="rows-parcelle"></div>

      <div class="recap-group-title">Prix & Paiement</div>
      <div class="recap-rows" id="rows-prix"></div>

      <div style="text-align:center;margin-top:1.5rem;">
        <button id="btnPayer" type="button" class="btn-gold"><i class="fa-solid fa-wallet"></i> Procéder au paiement (Orange Money)</button>
      </div>
    </div>
  </main>

  <!-- ==== MODAL PAIEMENT (unique, masquée par défaut) ==== -->
  <div id="paymentModal" class="payment-modal" aria-hidden="true">
    <div class="pm-dialog" role="dialog" aria-modal="true" aria-labelledby="pmTitle">
      <button id="pmClose" class="pm-close" aria-label="Fermer">&times;</button>
      <h2 id="pmTitle" class="pm-title">Paiement Orange Money</h2>

      <div class="beneficiary-box">
        <div>
          <span style="font-size:.72rem;text-transform:uppercase;color:#4c6a5d;font-weight:600">Numéro bénéficiaire</span>
          <div style="font-weight:700;color:#0f402d">(+224) 613 47 55 74</div>
        </div>
        <div>
          <span style="font-size:.72rem;text-transform:uppercase;color:#4c6a5d;font-weight:600">Nom bénéficiaire</span>
          <div style="font-weight:700;color:#0f402d">Odile Beindia</div>
        </div>
        <div>
          <span style="font-size:.72rem;text-transform:uppercase;color:#4c6a5d;font-weight:600">Montant à payer</span>
          <div id="pmAmount" style="font-weight:700;color:#0f402d">1 000 000 GNF</div>
        </div>
      </div>

      <ul class="moov-steps" style="margin-top:1rem;">
        <li><span class="step-index">1</span> Composez <strong>#144#</strong> sur votre téléphone.</li>
        <li><span class="step-index">2</span> Choisissez <strong>« Transfert d’argent »</strong>.</li>
        <li><span class="step-index">3</span> Saisissez le numéro bénéficiaire : <strong>(+224) 613 47 55 74</strong>.</li>
        <li><span class="step-index">4</span> Entrez le montant affiché.</li>
        <li><span class="step-index">5</span> Validez avec votre code PIN.</li>
        <li><span class="step-index">6</span> Conservez le SMS et envoyez la capture via WhatsApp.</li>
      </ul>

      <div class="whatsapp-pay-wrapper">
        <a id="whatsappPayBtn" class="whatsapp-pay-btn" target="_blank" rel="noopener" href="#">
          <i class="fa-brands fa-whatsapp"></i> Envoyer la capture via WhatsApp
        </a>
      </div>
    </div>
  </div>

  <script>
  /***********************************************************************
   * BCF - SCRIPT UNIQUE & PROPRE
   * - Injection récap et calculs (localStorage/sessionStorage)
   * - Compteur 25 min persistant via sessionStorage
   * - Modal info qui déclenche le démarrage du timer / intent
   * - Modal paiement (affiche le montant calculé et construit lien WhatsApp)
   ************************************************************************/

  (function(){
    'use strict';

    /* ==== CONFIG ==== */
    const FRAIS_INSCRIPTION_GNF = 1000000;
    const DEFAULT_PRICE_M2_GNF = 50000; // fallback
    const TOTAL_SECONDS = 25 * 60; // 25 minutes
    const TIME_KEY = 'bcf_payment_endAt_v1'; // sessionStorage key (persist pour onglet)
    const INTENT_KEY = 'paiementIntent';     // localStorage key pour debug / reprise multi-onglets

    /* ==== HELPERS ==== */
    const nf = (n) => new Intl.NumberFormat('fr-FR').format(Math.round(Number(n) || 0));
    const nfWith = (n, suffix='') => nf(n) + (suffix ? ' ' + suffix : '');

    function safeJSONParse(s){
      try { return JSON.parse(s || '{}'); } catch(e) { return {}; }
    }

    function parseAmountToGnf(v){
      if(v === null || typeof v === 'undefined') return 0;
      if(typeof v === 'number') return Math.round(v);
      const s = String(v).trim();
      const hasFCFA = /fcfa|cfa/i.test(s);
      const hasGNF  = /gnf/i.test(s);
      let num = s.replace(/\s/g,'').replace(/,/g,'.').replace(/[^\d\.\-]/g,'');
      const n = parseFloat(num) || 0;
      if(hasFCFA) return Math.round(n * 15.1515151515);
      if(hasGNF) return Math.round(n);
      return Math.round(n);
    }

    function formatGnf(n){ return nf(Math.round(n)) + ' GNF'; }

    /* ==== LECTURE / INJECTION PARCELLE & USER DATA ==== */
    function findParcelRaw(){
      return sessionStorage.getItem('selectedParcel')
        || sessionStorage.getItem('parcelleChoisie')
        || localStorage.getItem('selectedParcel')
        || localStorage.getItem('parcelleChoisie')
        || null;
    }

    function getParcelObject(){
      const raw = findParcelRaw();
      if(!raw) return {};
      try { return JSON.parse(raw); } catch(e) { return {}; }
    }

    function getUserData(){
      return safeJSONParse(localStorage.getItem('userData'));
    }

    function buildRecapRows(){
      const user = getUserData();
      const parcel = getParcelObject();

      const fallback = (v) => (v === undefined || v === null || v === '') ? '---' : v;
      const row = (label, value) => `<div class="recap-row"><div class="recap-label">${label}</div><div class="recap-value">${fallback(value)}</div></div>`;

      // Identité
      const rowsPersonnel = [
        row('Nom', user.nom),
        row('Prénom', user.prenom),
        row('Date de naissance', user.date_naissance),
        row('Lieu de naissance', user.lieu_naissance),
        row('Nationalité', user.nationalite)
      ].join('');

      // Pièce
      const rowsPiece = [
        row('Type de document', user.type_document),
        row('Numéro de pièce', user.numero_piece),
        row('Date d’établissement', user.date_etablissement),
        row('Lieu d’établissement', user.lieu_etablissement)
      ].join('');

      // Contacts
      const rowsContacts = [
        row('Téléphone', user.telephone),
        row('Email', user.email)
      ].join('');

      const adresseComplete = [user.adresse_ville, user.adresse_region, user.pays || user.adresse_pays]
        .filter(Boolean).join(', ') || '---';

      const rowsAdresse = [
        row('Profession', user.profession),
        row('Pays', user.pays || user.adresse_pays),
        row('Région', user.adresse_region),
        row('Ville', user.adresse_ville),
        row('Adresse complète', adresseComplete)
      ].join('');

      // Parcelle
      const selectedType = (localStorage.getItem('typeParcelle') || parcel.type || '').toLowerCase();
      const code = parcel.code || parcel.id || '';
      const section = parcel.section || parcel.zone || '';
      const lot = parcel.lot || parcel.sub || '';
      const surfaceNum = Number(parseFloat(parcel.surface || parcel.superficie || 0) || 0);
      const surfaceTxt = surfaceNum ? (nf(surfaceNum) + ' m²') : '---';

      const rowsParcelle = [
        row('Type de parcelle', selectedType ? selectedType.charAt(0).toUpperCase() + selectedType.slice(1) : '---'),
        row('Code', code || '---'),
        row('Section', section || '---'),
        row('Lot', lot || '---'),
        row('Surface', surfaceTxt)
      ].join('');

      // Prix
      const prixM2Raw = parcel.pricePerM2 || parcel.prixUnitaire || parcel.prix_m2 || parcel.PRIX_M2 || 0;
      const prixM2 = parseAmountToGnf(prixM2Raw || (selectedType === 'commercial' ? undefined : undefined)) || DEFAULT_PRICE_M2_GNF;
      const prixTotal = parseAmountToGnf(parcel.priceTotal || parcel.prix || parcel.total || Math.round(surfaceNum * prixM2));
      const reste = Math.round(prixTotal + FRAIS_INSCRIPTION_GNF);

      const rowsPrix = [
        row('Prix / m²', nfWith(prixM2, 'GNF')),
        row('Prix total', nfWith(prixTotal, 'GNF')),
        row('Frais d’inscription', `<span class="price-highlight">${nfWith(FRAIS_INSCRIPTION_GNF,'GNF')}</span>`),
        row('Reste à payer', `<span class="price-highlight">${nfWith(reste,'GNF')}</span>`)
      ].join('');

      // inject
      const mount = (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; };
      mount('rows-personnel', rowsPersonnel);
      mount('rows-piece', rowsPiece);
      mount('rows-contacts', rowsContacts);
      mount('rows-adresse', rowsAdresse);
      mount('rows-parcelle', rowsParcelle);
      mount('rows-prix', rowsPrix);

      // expose pour d'autres scripts/modales
      window.__paiementRecap = {
        userData: user,
        parcel,
        prixM2,
        prixTotal,
        reste,
        fraisInscription: FRAIS_INSCRIPTION_GNF,
        surface: surfaceNum,
        code
      };

      // update modal payment amount and whatsapp link
      const pmAmountEl = document.getElementById('pmAmount');
      const payAmountModal = FRAIS_INSCRIPTION_GNF; // montant fixe à afficher
      if(pmAmountEl) pmAmountEl.textContent = formatGnf(payAmountModal);

      // build WhatsApp template (user phone + montant + code)
      const phone = (user.telephone || '').replace(/\s+/g,'');
      const beneficiary = '+224613079246'; // lien wa to this number for capture sending (keep as-is or modify)
      const msgParts = [
        "Je viens d'effectuer le paiement Orange Money pour la souscription.",
        `Montant: ${formatGnf(payAmountModal)}.`,
        (code ? `Réf parcelle: ${code}.` : ''),
        "Voici ma capture :"
      ];
      const waText = encodeURIComponent(msgParts.join(' '));
      const waHref = `https://wa.me/${beneficiary.replace(/[^\d+]/g,'')}?text=${waText}`;
      const waBtn = document.getElementById('whatsappPayBtn');
      if(waBtn) waBtn.setAttribute('href', waHref);
    }

    /* ==== COMPTEUR (persistant via sessionStorage) ==== */
    (function setupCountdown(){
      const pcTime = document.getElementById('pcTime');
      const expireMsg = document.getElementById('paymentExpireMsg');
      const btnPay = document.getElementById('btnPayer');

      if(!pcTime || !btnPay) return;

      let intervalId = null;

      function format(sec){
        const m = Math.floor(sec/60), s = Math.max(0, sec%60);
        return String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
      }

      function startTimer(endAt){
        if(intervalId) clearInterval(intervalId);
        function tick(){
          const remainingMs = endAt - Date.now();
          const remainingSec = Math.max(0, Math.ceil(remainingMs/1000));
          pcTime.textContent = format(remainingSec);
          if(remainingSec <= 0){
            clearInterval(intervalId);
            btnPay.disabled = true;
            if(expireMsg){
              expireMsg.textContent = 'Temps écoulé, veuillez recommencer la procédure.';
              expireMsg.classList.add('show');
            }
            sessionStorage.removeItem(TIME_KEY);
          }
        }
        tick();
        intervalId = setInterval(tick, 1000);
      }

      function initTimerPersist(){
        const endAt = Date.now() + TOTAL_SECONDS * 1000;
        sessionStorage.setItem(TIME_KEY, String(endAt));
        startTimer(endAt);
        return endAt;
      }

      // restore if exists and valid
      const stored = sessionStorage.getItem(TIME_KEY);
      if(stored){
        const endAt = Number(stored);
        if(!isNaN(endAt) && endAt > Date.now()){
          startTimer(endAt);
        } else {
          sessionStorage.removeItem(TIME_KEY);
          pcTime.textContent = format(TOTAL_SECONDS);
        }
      } else {
        pcTime.textContent = format(TOTAL_SECONDS);
      }

      // Expose functions to start externally
      window.BCF_Timer = {
        init: initTimerPersist,
        isRunning: function(){ const s = sessionStorage.getItem(TIME_KEY); return !!s && Number(s) > Date.now(); },
        getRemaining: function(){ const s = sessionStorage.getItem(TIME_KEY); return s ? Math.max(0, Math.ceil((Number(s)-Date.now())/1000)) : TOTAL_SECONDS; }
      };

    })();

    /* ==== MODALES (info et paiement) ==== */
    (function setupModals(){
      const infoModal = document.getElementById('paymentInfoModal'); // mm modal
      const pimProceed = document.getElementById('pimProceed');
      const pimCancel = document.getElementById('pimCancel');
      const pimClose  = document.getElementById('pimClose');

      const paymentModal = document.getElementById('paymentModal');
      const btnPayer = document.getElementById('btnPayer');
      const pmClose = document.getElementById('pmClose');

      function openInfo(){
        if(!infoModal) return;
        infoModal.style.display = 'flex';
        infoModal.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
      }
      function closeInfo(){
        if(!infoModal) return;
        infoModal.style.display = 'none';
        infoModal.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }

      function openPaymentModal(){
        if(!paymentModal) return;
        // Montant affiché : toujours 1 000 000 GNF (frais inscription)
        const pmAmountEl = document.getElementById('pmAmount');
        if(pmAmountEl) pmAmountEl.textContent = formatGnf(FRAIS_INSCRIPTION_GNF);
        paymentModal.classList.add('open');
        paymentModal.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
      }
      function closePaymentModal(){
        if(!paymentModal) return;
        paymentModal.classList.remove('open');
        paymentModal.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }

      // show info modal on load (optional UX). We'll show it to inform the user.
      openInfo();

      // Bind info modal buttons
      pimProceed && pimProceed.addEventListener('click', function(){
        // start timer if not started
        if(!window.BCF_Timer.isRunning()){
          const endAt = window.BCF_Timer.init();
          // store intent in localStorage for multi-onglets awareness/debug
          try{
            const intent = { ts: Date.now(), endAt, source: 'pimProceed' };
            localStorage.setItem(INTENT_KEY, JSON.stringify(intent));
          }catch(e){}
        }
        closeInfo();
      });

      pimCancel && pimCancel.addEventListener('click', function(){
        // cancel: cleanup session timer and go home
        sessionStorage.removeItem(TIME_KEY);
        closeInfo();
        window.location.href = 'index.html';
      });

      pimClose && pimClose.addEventListener('click', closeInfo);

      // Btn payer opens the payment modal and also ensures timer exists
      btnPayer && btnPayer.addEventListener('click', function(e){
        if(btnPayer.disabled){ e.preventDefault(); return; }
        if(!window.BCF_Timer.isRunning()){
          const endAt = window.BCF_Timer.init();
          try{
            localStorage.setItem(INTENT_KEY, JSON.stringify({ ts: Date.now(), endAt, source: 'btnPayer' }));
          }catch(e){}
        }
        openPaymentModal();
      });

      // close payment modal
      pmClose && pmClose.addEventListener('click', closePaymentModal);
      // click outside to close
      paymentModal && paymentModal.addEventListener('click', function(e){
        if(e.target === paymentModal) closePaymentModal();
      });
      // esc to close
      document.addEventListener('keydown', function(e){
        if(e.key === 'Escape'){
          closeInfo();
          closePaymentModal();
        }
      });

    })();

    /* ==== INIT ==== */
    document.addEventListener('DOMContentLoaded', function(){
      buildRecapRows();
      // Optional: debug show of keys
      const dbg = document.getElementById('localDebug');
      if(dbg){
        dbg.style.display = 'block';
        dbg.textContent = 'session.selectedParcel / local.userData: ' + (sessionStorage.getItem('selectedParcel') ? 'OK' : 'NO') + ' / ' + (localStorage.getItem('userData') ? 'OK' : 'NO');
      }
    });

    /* ==== Synchronisation multi-onglets (optionnel mais utile) ==== */
    // Si un autre onglet modifie INTENT_KEY (paiement démarré), on peut démarrer timer local aussi
    window.addEventListener('storage', function(e){
      if(e.key === INTENT_KEY && e.newValue){
        try{
          const obj = JSON.parse(e.newValue);
          if(obj && obj.endAt && Number(obj.endAt) > Date.now() && !window.BCF_Timer.isRunning()){
            // write the endAt into session storage for this tab and start
            sessionStorage.setItem(TIME_KEY, String(Number(obj.endAt)));
            // start timer
            if(window.BCF_Timer && typeof window.BCF_Timer.init === 'function') {
              // window.BCF_Timer.init will create a new endAt, so instead call start directly via a tiny helper:
              const startAt = Number(obj.endAt);
              // Start by calling internal function: we don't have direct access but the countdown routine listens to sessionStorage change on load; easiest is a soft reload
              // we'll set pcTime quickly and then reload to pick up the timer (cheap and reliable)
              try{ location.reload(); } catch(err){}
            }
          }
        }catch(err){}
      }
      // If parcel selection updated elsewhere, rebuild recap
      if(['selectedParcel','parcelleChoisie'].includes(e.key)){
        buildRecapRows();
      }
    });

  })();
  </script>
</body>
</html>
